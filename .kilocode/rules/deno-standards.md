# Deno Standards for TSera

## Deno v2 Requirements

TSera requires **Deno v2** with strict ESM-only modules. No Node.js/npm compatibility layers unless
absolutely necessary.

### Version Enforcement

- Always check Deno version: `deno --version` must be v2.x
- Update via `deno upgrade` when needed
- CI/CD should enforce minimum Deno v2 version

### ESM-Only Architecture

- No CommonJS modules
- No `require()` calls
- Use ES6 import/export syntax exclusively
- No mixed module systems

## TSera CLI Dependencies

### Allowed CLI Dependencies

Only these dependencies are permitted in TSera CLI itself:

- **Deno std**: `@std/path`, `@std/fs`, `@std/assert`, `@std/fmt`
- **Cliffy**: `jsr:@cliffy/command@1.0.0-rc.7`, `jsr:@cliffy/prompt@1.0.0-rc.7`
- **Zod v4**: `jsr:@zod/zod@^4.1.13`
- **TS-Morph**: `jsr:@ts-morph/ts-morph@23`

### CLI Dependency Resolution

- Use JSR imports when available: `jsr:@std/path@^1.1.3`
- Import aliases defined in `deno.jsonc` imports section
- No `import_map.json` file - use deno.jsonc imports instead
- Prefer JSR over npm for all CLI dependencies

## Generated Project Dependencies

### Generated Project Allowed Dependencies

Projects generated by `tsera init` may include these dependencies:

- **Hono**: API framework (when `--no-hono` is NOT specified)
- **Fresh**: Frontend framework (when `--no-fresh` is NOT specified)
- **Preact**: Required by Fresh, installed via npm
- **Drizzle**: ORM for database operations
- **Database drivers**: PostgreSQL, MySQL, SQLite as needed
- **Testing utilities**: Deno's built-in test framework

### Generated Project Import Patterns

```typescript
// In generated projects, use standard patterns
import { Hono } from "hono";
import { fresh } from "fresh";
import { drizzle } from "drizzle-orm";
import { z } from "zod";
```

## Dependency Separation

### CLI vs Generated Projects

- **CLI**: Minimal dependencies, focused on code generation
- **Generated projects**: Full application dependencies
- **Templates**: Define which dependencies to include
- **Module flags**: Control dependency inclusion (`--no-hono`, `--no-fresh`)

### Template Dependency Management

- Templates specify their own dependencies
- CLI validates template dependencies before generation
- Conflicts between template dependencies are resolved by CLI
- Version compatibility is maintained by CLI

## Permissions and Security

### CLI Permissions

- CLI runs with `-A` (all permissions) but should request minimum needed
- File system access limited to project directory and subdirectories
- Network access only when explicitly needed (updates, template fetching)
- No environment variable access without explicit user consent

### Generated Project Permissions

- Generated projects should use minimal permissions
- Hono modules need `--allow-net` for web servers
- Database access requires `--allow-read` and `--allow-write` for specific paths
- Fresh frontend needs `--allow-net` and `--allow-read` for static files

### Security Boundaries

- No file system access outside project root
- No execution of external commands without validation
- Validate all user inputs before file operations
- Sanitize paths to prevent directory traversal

## Configuration Standards

### CLI deno.jsonc Structure

```jsonc
{
  "compilerOptions": {
    "strict": true
  },
  "fmt": {
    "useTabs": false,
    "lineWidth": 100,
    "indentWidth": 2
  },
  "lint": {
    "rules": {
      "tags": ["recommended"]
    }
  },
  "imports": {
    "cliffy/command": "jsr:@cliffy/command@1.0.0-rc.7",
    "cliffy/prompt": "jsr:@cliffy/prompt@1.0.0-rc.7",
    "std/assert": "jsr:@std/assert@^1.0.16",
    "std/fs": "jsr:@std/fs@^1.0.20",
    "std/fs/walk": "jsr:@std/fs@^1.0.20/walk",
    "std/path": "jsr:@std/path@^1.1.3",
    "ts-morph": "jsr:@ts-morph/ts-morph@23",
    "tsera/": "./src/",
    "zod": "jsr:@zod/zod@^4.1.13"
  },
  "tasks": {
    "tsera": "deno run -A src/cli/main.ts",
    "fmt": "deno fmt",
    "lint": "deno lint",
    "test": "deno test -A --unstable-kv",
    "e2e": "deno test -A --unstable-kv e2e.test.ts",
    "compile": "deno compile -A --output dist/tsera src/cli/main.ts",
    "publish": "deno publish"
  }
}
```

### Generated Project deno.jsonc Structure

```jsonc
{
  "compilerOptions": {
    "strict": true
  },
  "fmt": {
    "useTabs": false,
    "lineWidth": 100,
    "indentWidth": 2
  },
  "lint": {
    "rules": {
      "tags": ["recommended"]
    }
  },
  "imports": {
    "hono": "hono",
    "fresh": "fresh",
    "zod": "zod"
    // Additional imports based on selected modules
  },
  "tasks": {
    "dev": "deno run -A app/back/main.ts",
    "fmt": "deno fmt",
    "lint": "deno lint",
    "test": "deno test -A"
  }
}
```

## Import Patterns

### CLI Import Order

1. External dependencies (JSR, npm)
2. Internal modules (`src/`)
3. Relative imports within same module
4. Type-only imports when possible

### CLI Import Aliases

- Use aliases defined in `deno.jsonc` imports section
- `tsera/` maps to `./src/` for development
- Standard library aliases: `std/` for `@std/`

### CLI Import Examples

```typescript
// External (JSR)
import { Command } from "cliffy/command";
import { z } from "zod";
import { resolve } from "std/path";

// Internal (using alias)
import { defineEntity } from "tsera/core/entity.ts";
import { TseraConfig } from "tsera/cli/definitions.ts";

// Relative (within module)
import { buildSchema } from "./schema.ts";
import type { FieldDef } from "./types.ts";
```

## Runtime Standards

### Error Handling

- Use Deno-native error types when appropriate
- Provide clear, actionable error messages
- Exit with appropriate codes: 0 (success), 1 (error), 2 (usage)
- No silent failures or swallowed exceptions

### File System Operations

- Use `std/fs` for file operations
- Prefer atomic operations where possible
- Use `Deno.makeTempDir()` for temporary files
- Clean up temporary resources in finally blocks

### Async Patterns

- Use top-level await where appropriate
- Prefer async/await over Promise chains
- Handle async errors properly with try/catch
- Use `Deno.watchFs` for file watching with proper cleanup

## Testing Standards

### Test Structure

- Use `Deno.test` for all tests
- Organize tests in `tests/` subdirectories
- Use test steps with `t.step()` for complex tests
- Include setup/teardown with `beforeEach`/`afterEach`

### Test Permissions

- Tests run with `-A` but should document required permissions
- Use `Deno.permissions.query()` to check available permissions
- Mock external dependencies in unit tests
- Integration tests should test with minimal permissions

## Performance Guidelines

### Startup Performance

- Minimize imports on startup
- Lazy load heavy dependencies when possible
- Use `Deno.stat()` to check file existence before reading
- Cache expensive operations

### Memory Usage

- Avoid large in-memory operations
- Stream large files instead of loading entirely
- Clean up resources properly
- Monitor memory usage in long-running processes

## Compatibility Requirements

### Platform Support

- Windows, macOS, Linux support required
- Use `std/path` for cross-platform path operations
- Handle platform-specific differences gracefully
- Test on all supported platforms

### Browser Compatibility

- Core entity system should be browser-compatible
- CLI parts are Deno-specific
- Use conditional exports for different environments
- Document browser compatibility clearly

## Development Workflow

### Local Development

- Use `deno task tsera` for CLI development
- Use `deno task fmt && deno task lint` before commits
- Use `deno task test` for unit tests
- Use `deno task e2e` for end-to-end tests

### Cache Management

- Use `deno cache --lock=deno.lock --lock-write` to update lock
- Commit `deno.lock` to version control
- Use `--reload` flag when developing with local changes
- Clear cache only when necessary (corruption, major changes)

### Environment Variables

- Use `DENO_NO_PROMPT=1` for non-interactive CI
- Document required environment variables clearly
- Provide sensible defaults for optional variables
- Validate environment variables on startup
